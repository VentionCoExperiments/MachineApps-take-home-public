services:
  ursim:
    image: universalrobots/ursim_e-series
    container_name: ursim
    environment:
      - ROBOT_MODEL=UR5e
    ports:
      # VNC access for PolyScope UI
      - "5900:5900"
      # noVNC web access (recommended)
      - "6080:6080"
      # UR interfaces
      - "29999:29999"   # Dashboard server
      - "30001:30001"   # Primary interface
      - "30002:30002"   # Secondary interface
      - "30003:30003"   # Real-time interface
      - "30004:30004"   # RTDE interface
    volumes:
      - ursim_programs:/ursim/programs
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/30001' 2>/dev/null"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 60s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: palletizer-backend
    ports:
      - "8000:8000"
    environment:
      - ROBOT_HOST=ursim
      - ROBOT_PORT=30004
    depends_on:
      ursim:
        condition: service_healthy
    volumes:
      - ./backend:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

volumes:
  ursim_programs:
